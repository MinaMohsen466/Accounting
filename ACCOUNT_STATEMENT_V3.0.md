# 🎯 تحديث كشف الحساب - الإصدار 3.0

**التاريخ**: 19 أكتوبر 2025  
**الحالة**: ✅ مكتمل

---

## 📋 التحديثات الرئيسية

### 1. ✨ إضافة الرصيد الابتدائي للعميل/المورد

#### المشكلة السابقة:
- كان النظام يبدأ دائماً بـ `openingBalance = 0`
- لم يتم احتساب الرصيد الابتدائي المسجل للعميل أو المورد

#### الحل المطبق:
```javascript
// في useAccounting.js
const entity = entityType === 'customer' 
  ? customers.find(c => c.id === entityId)
  : suppliers.find(s => s.id === entityId)

// البدء بالرصيد الابتدائي للعميل/المورد
let openingBalance = parseFloat(entity?.balance || 0)
```

#### المثال العملي:
```
📊 قبل التحديث:
العميل: محمد أحمد
الرصيد المسجل في البيانات: 500 د.ك
الرصيد الافتتاحي في الكشف: 0 د.ك ❌

✅ بعد التحديث:
العميل: محمد أحمد
الرصيد المسجل في البيانات: 500 د.ك
الرصيد الافتتاحي في الكشف: 500 د.ك ✅
```

---

### 2. 🏷️ تغيير عمود الحالة إلى دائن/مدين

#### المشكلة السابقة:
كان عمود الحالة يعرض:
- ✅ مدفوعة
- ⏳ معلقة
- ⚠️ متأخرة

#### الحل الجديد:
الآن عمود النوع يعرض:
- 📤 **مدين** (Debit) - عندما يكون المبلغ في خانة المدين فقط
- 📥 **دائن** (Credit) - عندما يكون المبلغ في خانة الدائن فقط
- 📋 **مدين ودائن** (Debit & Credit) - عندما يكون في كلا الخانتين (فاتورة مدفوعة)

#### الشكل الجديد:

```
┌──────────┬────────────┬─────────────────┬────────────────┬───────┬───────┬─────────┐
│ التاريخ  │ الفاتورة   │ الوصف          │ النوع         │ مدين │ دائن │ الرصيد │
├──────────┼────────────┼─────────────────┼────────────────┼───────┼───────┼─────────┤
│01/10/2025│    -       │ رصيد افتتاحي    │     -          │  -    │  -    │ 500.000 │
├──────────┼────────────┼─────────────────┼────────────────┼───────┼───────┼─────────┤
│02/10/2025│ S0001      │ فاتورة مبيعات   │ 📋 مدين ودائن │100.000│100.000│ 500.000 │
├──────────┼────────────┼─────────────────┼────────────────┼───────┼───────┼─────────┤
│05/10/2025│ S0002      │ فاتورة مبيعات   │ 📤 مدين       │200.000│   -   │ 700.000 │
├──────────┼────────────┼─────────────────┼────────────────┼───────┼───────┼─────────┤
│           │            │ الرصيد الختامي  │                │300.000│100.000│ 700.000 │
└──────────┴────────────┴─────────────────┴────────────────┴───────┴───────┴─────────┘
```

---

## 🎨 التنسيقات الجديدة (CSS)

### Type Badges - على الشاشة:

```css
.type-badge.debit {
  background-color: #e3f2fd;    /* أزرق فاتح */
  color: #1565c0;               /* أزرق غامق */
  border: 1px solid #90caf9;
}

.type-badge.credit {
  background-color: #f3e5f5;    /* بنفسجي فاتح */
  color: #6a1b9a;               /* بنفسجي غامق */
  border: 1px solid #ce93d8;
}

.type-badge.both {
  background-color: #fff9e6;    /* برتقالي فاتح */
  color: #f57c00;               /* برتقالي */
  border: 1px solid #ffb74d;
}
```

### للطباعة:

```css
@media print {
  .type-badge.debit {
    background-color: #e3f2fd !important;
    color: #1565c0 !important;
    border-color: #1565c0;
  }

  .type-badge.credit {
    background-color: #f3e5f5 !important;
    color: #6a1b9a !important;
    border-color: #6a1b9a;
  }

  .type-badge.both {
    background-color: #fff9e6 !important;
    color: #f57c00 !important;
    border-color: #f57c00;
  }
}
```

---

## 📊 منطق تحديد النوع

```javascript
// في AccountStatement.jsx
const isDebitRow = trans.debit > 0 && trans.credit === 0    // مدين فقط
const isCreditRow = trans.credit > 0 && trans.debit === 0   // دائن فقط
const isBothRow = trans.debit > 0 && trans.credit > 0       // كلاهما (مدفوعة)
```

### أمثلة عملية:

#### مثال 1: فاتورة غير مدفوعة لعميل
```javascript
{
  debit: 100.000,    // العميل مدين لنا
  credit: 0,
  النوع: "📤 مدين"
}
```

#### مثال 2: فاتورة مدفوعة لعميل
```javascript
{
  debit: 100.000,    // الفاتورة
  credit: 100.000,   // السداد
  النوع: "📋 مدين ودائن"
}
```

#### مثال 3: فاتورة غير مدفوعة من مورد
```javascript
{
  debit: 0,
  credit: 200.000,   // نحن مدينون للمورد
  النوع: "📥 دائن"
}
```

---

## 📄 التصدير إلى Excel

### التحديث في دالة exportToExcel:

```javascript
// تحديد النوع
const typeText = isBothRow 
  ? (language === 'ar' ? 'مدين ودائن' : 'Debit & Credit')
  : isDebitRow 
    ? (language === 'ar' ? 'مدين' : 'Debit')
    : isCreditRow 
      ? (language === 'ar' ? 'دائن' : 'Credit')
      : '-'

// في CSV
csv += `${trans.date},"${trans.invoiceNumber}","${trans.description}","${typeText}",${trans.debit.toFixed(3)},${trans.credit.toFixed(3)},${trans.balance.toFixed(3)}\n`
```

### شكل ملف CSV:

```csv
كشف حساب
عميل: محمد أحمد التجاري
الهاتف: +965 1234 5678
من تاريخ: 2025-10-01 إلى تاريخ: 2025-10-19

التاريخ,رقم الفاتورة,الوصف,النوع,مدين,دائن,الرصيد
2025-10-01,-,رصيد افتتاحي,-,,,500.000
2025-10-02,S0001,فاتورة مبيعات,مدين ودائن,100.000,100.000,500.000
2025-10-05,S0002,فاتورة مبيعات,مدين,200.000,0.000,700.000
,,,الرصيد الختامي,300.000,100.000,700.000
```

---

## 🔍 سيناريوهات الاستخدام

### السيناريو 1: عميل لديه رصيد ابتدائي موجب

```
بيانات العميل:
- الاسم: أحمد محمد
- الرصيد المسجل: 300 د.ك (له - مدين)

الفواتير:
1. فاتورة S001: 100 د.ك (مدفوعة)
2. فاتورة S002: 150 د.ك (معلقة)

الكشف:
┌─────────────────┬────────┬────────┬─────────┐
│ الوصف          │ مدين  │ دائن  │ الرصيد │
├─────────────────┼────────┼────────┼─────────┤
│ رصيد افتتاحي    │   -    │   -    │ 300.000 │ ← الرصيد الابتدائي
│ S001 مدفوعة    │100.000 │100.000 │ 300.000 │
│ S002 معلقة     │150.000 │   -    │ 450.000 │ ← الرصيد النهائي
└─────────────────┴────────┴────────┴─────────┘
```

### السيناريو 2: مورد لديه رصيد ابتدائي سالب

```
بيانات المورد:
- الاسم: شركة الإمداد
- الرصيد المسجل: -500 د.ك (عليه - دائن)

الفواتير:
1. فاتورة P001: 200 د.ك (مدفوعة)
2. فاتورة P002: 300 د.ك (معلقة)

الكشف:
┌─────────────────┬────────┬────────┬──────────┐
│ الوصف          │ مدين  │ دائن  │ الرصيد  │
├─────────────────┼────────┼────────┼──────────┤
│ رصيد افتتاحي    │   -    │   -    │ -500.000 │ ← الرصيد الابتدائي
│ P001 مدفوعة    │200.000 │200.000 │ -500.000 │
│ P002 معلقة     │   -    │300.000 │ -800.000 │ ← نحن ندين له بـ 800
└─────────────────┴────────┴────────┴──────────┘
```

### السيناريو 3: عميل جديد بدون رصيد ابتدائي

```
بيانات العميل:
- الاسم: عميل جديد
- الرصيد المسجل: 0 د.ك

الفواتير:
1. فاتورة S010: 500 د.ك (معلقة)

الكشف:
┌─────────────────┬────────┬────────┬─────────┐
│ الوصف          │ مدين  │ دائن  │ الرصيد │
├─────────────────┼────────┼────────┼─────────┤
│ رصيد افتتاحي    │   -    │   -    │   0.000 │ ← بدون رصيد ابتدائي
│ S010 معلقة     │500.000 │   -    │ 500.000 │
└─────────────────┴────────┴────────┴─────────┘
```

---

## 🎯 نقاط مهمة للمستخدم

### ✅ الرصيد الابتدائي:
1. يتم جلبه **تلقائياً** من بيانات العميل/المورد
2. يظهر في **أول سطر** من الكشف
3. يمكن تعديله من صفحة **العملاء والموردين**

### 🏷️ الأنواع:
- **📤 مدين**: الفاتورة للعميل أو السداد للمورد
- **📥 دائن**: السداد من العميل أو الفاتورة من المورد
- **📋 مدين ودائن**: فاتورة مدفوعة (تظهر في سطر واحد)

### 🎨 الألوان:
- **أزرق**: مدين
- **بنفسجي**: دائن
- **برتقالي**: كلاهما
- **أخضر**: رصيد موجب (له)
- **أحمر**: رصيد سالب (عليه)

---

## 🔧 التعديلات التقنية

### ملفات تم تعديلها:

#### 1. `src/hooks/useAccounting.js`
```javascript
// إضافة جلب بيانات العميل/المورد
const entity = entityType === 'customer' 
  ? customers.find(c => c.id === entityId)
  : suppliers.find(s => s.id === entityId)

// استخدام الرصيد الابتدائي
let openingBalance = parseFloat(entity?.balance || 0)
```

#### 2. `src/components/AccountStatement.jsx`
- تغيير عمود "الحالة" إلى "النوع"
- إضافة منطق تحديد النوع (مدين/دائن/كلاهما)
- تحديث exportToExcel لتضمين النوع

#### 3. `src/components/AccountStatement.css`
- إضافة `.type-badge` و subclasses
- تنسيقات للشاشة والطباعة
- ألوان مميزة لكل نوع

---

## 📸 قبل وبعد

### قبل التحديث ❌:
```
الرصيد الافتتاحي: 0.000 د.ك (غير صحيح)
عمود الحالة: مدفوعة/معلقة/متأخرة
```

### بعد التحديث ✅:
```
الرصيد الافتتاحي: 500.000 د.ك (من بيانات العميل)
عمود النوع: مدين/دائن/مدين ودائن
```

---

## ✅ قائمة التحقق

- [x] إضافة الرصيد الابتدائي من بيانات العميل/المورد
- [x] تغيير عمود الحالة إلى النوع
- [x] إضافة Type Badges (مدين/دائن/كلاهما)
- [x] تحديث منطق العرض في الجدول
- [x] تحديث دالة التصدير CSV
- [x] إضافة تنسيقات CSS للأنواع
- [x] تنسيقات الطباعة
- [x] اختبار عدم وجود أخطاء

---

## 🎉 النتيجة النهائية

### الآن كشف الحساب يعرض:
✅ **الرصيد الابتدائي الصحيح** من بيانات العميل/المورد  
✅ **أنواع واضحة**: مدين، دائن، أو كلاهما  
✅ **ألوان مميزة** لكل نوع  
✅ **طباعة محسّنة** مع حفظ الألوان  
✅ **تصدير دقيق** يتضمن النوع  

---

**الإصدار**: 3.0  
**الحالة**: ✅ جاهز للاستخدام  
**التاريخ**: 19 أكتوبر 2025

# ميزة تعديل الفواتير (المنطق الصحيح)
## Invoice Edit Feature (Correct Logic)

## التحديثات (Updates)

### 1. التمييز بين فواتير المبيعات والمشتريات
**Differentiation Between Sales and Purchase Invoices**

#### 🛒 فواتير المبيعات (Sales Invoices)
- ✅ **يمكن تعديل جميع القيم المالية** (Can edit all financial values)
- ✅ **التعديلات المتاحة:**
  - تغيير الكمية (Change quantity)
  - تغيير السعر (Change price)
  - تغيير الخصم (Change discount)
  - تغيير/إضافة المنتجات (Change/Add products)
  - حذف/إضافة عناصر (Delete/Add items)
  - تعديل الضريبة (Edit tax)
  - تعديل الملاحظات (Edit notes)
- 🔍 **التحقق التلقائي:** 
  - التحقق من توفر المنتجات في المخزون
  - عند زيادة الكمية: التأكد من توفر الكمية الإضافية
  - عند حذف منتج: يعود للمخزون تلقائياً
- ✅ **يمكن حذفها:** ترجع المنتجات للمخزون

#### 📦 فواتير المشتريات (Purchase Invoices)
- ❌ **لا يمكن تعديل القيم المالية** (Cannot edit financial values) - وثائق رسمية
- ✅ **يمكن تعديل الملاحظات فقط** (Can only edit notes)
- 🔒 **الحقول المعطلة:**
  - الكمية (Quantity)
  - السعر (Price)
  - الخصم (Discount)
  - المنتجات (Products)
  - إضافة/حذف عناصر (Add/Remove items)
- 🔄 **الخيارات البديلة:**
  - **زر "إرجاع"**: إرجاع كامل أو جزئي مع التحقق من المخزون
  - **زر "إرجاع وإعادة كتابة"**: يرجع الفاتورة ويفتح فورم جديد بنفس البيانات

### 2. رسائل التنبيه (Alert Messages)

#### فاتورة المشتريات (Purchase Invoice)
```
⚠️ تنبيه:
لا يمكن تعديل فواتير المشتريات لأنها وثائق رسمية من الموردين.
يمكنك فقط عرض الفاتورة أو تعديل الملاحظات.
لإجراء تغييرات، يرجى استخدام خيار "إرجاع وإعادة كتابة".
```

#### فاتورة المبيعات (Sales Invoice)
```
ℹ️ ملاحظة:
يمكنك تعديل فاتورة المبيعات (الكمية، السعر، الخصم، المنتجات).
سيتم التحقق من توفر المنتجات في المخزون تلقائياً.
```

### 3. منطق التعديل (Edit Logic)

#### عند تعديل فاتورة مبيعات:

```javascript
1. عكس تأثير الفاتورة القديمة على المخزون
   - إرجاع الكميات القديمة للمخزون (إضافة)
   - console.log: "📦 عكس تأثير الفاتورة القديمة على المخزون"

2. عكس القيود المحاسبية القديمة
   - استدعاء reverseJournalEntriesForInvoice
   - console.log: "📊 عكس القيود المحاسبية القديمة"

3. تطبيق الفاتورة الجديدة
   - تحديث بيانات الفاتورة في قاعدة البيانات
   - console.log: "✨ تطبيق الفاتورة المعدلة الجديدة"

4. تطبيق تأثير الفاتورة الجديدة على المخزون
   - خصم الكميات الجديدة من المخزون
   - console.log: "📦 تطبيق تأثير الفاتورة الجديدة على المخزون (خصم من المخزون)"

5. تسجيل القيود المحاسبية الجديدة
   - إذا كان recordPaymentNow مفعل: تسجيل الدفع
   - إذا كان deductFromBalance مفعل: خصم من الرصيد
   - console.log: "📊 تسجيل القيود المحاسبية الجديدة"
```

### 4. ميزة "إرجاع وإعادة كتابة" (Return & Rewrite)

#### للفواتير المشتريات فقط:
```javascript
1. التحقق من توفر جميع المنتجات في المخزون
   - يجب توفر الكمية الكاملة للإرجاع للمورد
   - إذا لم تتوفر: رسالة خطأ توضح المنتج والكمية المتوفرة

2. إنشاء فاتورة إرجاع
   - رقم الفاتورة: RET-[رقم الفاتورة الأصلية]
   - isReturn: true
   - returnReason: "إرجاع وإعادة كتابة"

3. تحديث المخزون
   - خصم الكميات من المخزون (لأنها ترجع للمورد)

4. فتح نموذج فاتورة جديدة
   - يتم ملء جميع البيانات من الفاتورة القديمة
   - رقم فاتورة جديد: PUR-[MMDD]-[XXX]
   - يمكن للمستخدم تعديل أي شيء قبل الحفظ
```

### 5. الأزرار في جدول الفواتير (Invoice Table Buttons)

#### لجميع الفواتير:
- **زر "عرض/تعديل"**: يفتح نافذة الفاتورة
- **زر "طباعة"**: يطبع الفاتورة

#### للفواتير الأصلية (غير المرتجعة):
- **زر "إرجاع" 🔄** (برتقالي): يفتح نافذة الإرجاع مع اختيار الكميات

#### لفواتير المشتريات الأصلية فقط:
- **زر "إرجاع وإعادة كتابة" ✏️** (أزرق): 
  - يرجع الفاتورة مباشرة
  - يفتح فورم جديد بنفس البيانات
  - يتحقق من المخزون قبل الإرجاع

#### للفواتير المرتجعة:
- **زر "حذف"** (أحمر): يحذف فاتورة الإرجاع

## السيناريوهات (Scenarios)

### سيناريو 1: تعديل كمية في فاتورة مبيعات
```
1. فتح فاتورة مبيعات موجودة
2. تغيير الكمية من 10 إلى 15
3. النظام يتحقق: هل يتوفر 5 قطع إضافية في المخزون؟
4. إذا توفرت:
   - يتم إرجاع 10 للمخزون
   - يتم خصم 15 من المخزون
   - تحديث القيود المحاسبية
5. إذا لم تتوفر: رسالة خطأ
```

### سيناريو 2: حذف منتج من فاتورة مبيعات
```
1. فتح فاتورة مبيعات موجودة
2. حذف منتج كان بكمية 8
3. عند الحفظ:
   - يتم إرجاع 8 قطع للمخزون
   - يتم تحديث القيود المحاسبية
   - المنتج لم يعد في الفاتورة
```

### سيناريو 3: "إرجاع وإعادة كتابة" لفاتورة مشتريات
```
1. عرض فاتورة مشتريات (مثلاً: PUR-1029-001)
2. النقر على زر "إرجاع وإعادة كتابة" ✏️
3. النظام يتحقق من توفر جميع المنتجات في المخزون
4. إذا توفرت:
   - يتم إنشاء فاتورة إرجاع: RET-PUR-1029-001
   - يتم خصم الكميات من المخزون
   - يفتح فورم فاتورة جديدة: PUR-1029-002
   - البيانات كلها مملوءة من الفاتورة القديمة
   - يمكن التعديل على أي شيء قبل الحفظ
5. إذا لم تتوفر: رسالة خطأ توضح المنتج المفقود
```

### سيناريو 4: محاولة تعديل فاتورة مشتريات
```
1. فتح فاتورة مشتريات موجودة
2. ظهور رسالة تنبيه باللون الأصفر
3. جميع الحقول المالية معطلة (رمادية)
4. يمكن تعديل الملاحظات فقط
5. للتغييرات المالية: 
   - خيار 1: زر "إرجاع" للإرجاع الجزئي/الكامل
   - خيار 2: زر "إرجاع وإعادة كتابة" لإنشاء فاتورة جديدة معدلة
```

## المنطق المحاسبي (Accounting Logic)

### لماذا فواتير المبيعات قابلة للتعديل؟
- **السبب:** قد تحدث أخطاء في إدخال فاتورة للعميل
- **الأمان:** يتم عكس جميع التأثيرات ثم إعادة تطبيقها
- **التحقق:** النظام يتحقق تلقائياً من توفر المنتجات
- **الشفافية:** جميع العمليات مسجلة في console.log

### لماذا فواتير المشتريات غير قابلة للتعديل؟
- **السبب:** هي وثائق رسمية من الموردين
- **الحماية:** منع التلاعب في أسعار وكميات المشتريات
- **البديل:** استخدام نظام الإرجاع أو "إرجاع وإعادة كتابة"
- **المرونة:** خيار "إرجاع وإعادة كتابة" يوفر إمكانية التصحيح

## الاختبار (Testing)

## الاختبار (Testing)

### اختبارات مطلوبة:
- [ ] إنشاء فاتورة مبيعات جديدة
- [ ] تعديل كمية في فاتورة مبيعات (زيادة)
- [ ] تعديل كمية في فاتورة مبيعات (نقصان)
- [ ] إضافة منتج جديد لفاتورة مبيعات
- [ ] حذف منتج من فاتورة مبيعات
- [ ] محاولة تعديل فاتورة مشتريات (يجب أن تفشل)
- [ ] إرجاع فاتورة مشتريات (جزئي)
- [ ] إرجاع فاتورة مشتريات (كامل)
- [ ] استخدام "إرجاع وإعادة كتابة" لفاتورة مشتريات
- [ ] التحقق من المخزون بعد كل عملية
- [ ] التحقق من القيود المحاسبية
- [ ] التحقق من أرصدة العملاء/الموردين

## الملفات المعدلة (Modified Files)
- `src/components/Invoices.jsx` (تم تعديل 400+ سطر)

## التاريخ (Date)
- **تاريخ التحديث:** 29 أكتوبر 2025
- **الإصدار:** v6.1 (المنطق الصحيح)

## الملاحظات (Notes)
- ✅ المنطق الصحيح: المبيعات قابلة للتعديل، المشتريات غير قابلة
- ✅ ميزة "إرجاع وإعادة كتابة" للمشتريات
- ✅ التحقق من المخزون في جميع العمليات
- ✅ تتبع كامل لجميع التغييرات عبر console.log
- ✅ حماية من التلاعب في وثائق الموردين

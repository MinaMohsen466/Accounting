# 📖 دليل المستخدم: حذف وتعديل الفواتير

## 🎯 الأساسيات

### ما الذي تغيّر؟
تم تطوير نظام شامل لحذف وتعديل الفواتير مع حماية قوية للبيانات والدقة المحاسبية.

---

## 🗑️ حذف الفواتير

### القاعدة العامة:
> **يمكن حذف الفاتورة إذا:**
> - ✅ ليست مرتجع
> - ✅ ليس لها مرتجعات مرتبطة
> - ✅ (للمشتريات فقط) الكمية متوفرة في المخزون

---

### خطوات حذف فاتورة:

1. **افتح صفحة الفواتير**
2. **ابحث عن الفاتورة المطلوبة**
3. **اضغط على زر 🗑️ "حذف"**
   - ⚠️ إذا لم يظهر الزر = الفاتورة مرتجع (لا يمكن حذفها)
4. **ستظهر رسالة تأكيد توضح:**
   - ✅ ماذا سيحدث للقيود المحاسبية
   - ✅ ماذا سيحدث للمخزون
5. **اضغط "موافق" للتأكيد**

---

### رسائل الخطأ المحتملة:

#### ❌ "لا يمكن حذف المرتجعات"
**السبب:** حاولت حذف مرتجع  
**الحل:** لا يمكن حذف المرتجعات - هذا متعمد لحماية البيانات

#### ❌ "يوجد X مرتجع مرتبط بهذه الفاتورة"
**السبب:** الفاتورة الأصلية لها مرتجعات  
**الحل:** احذف المرتجعات أولاً، ثم احذف الفاتورة الأصلية

#### ❌ "الأصناف التالية غير متوفرة"
**السبب:** تحاول حذف فاتورة مشتريات والمخزون لا يكفي  
**الحل:** 
- خيار 1: قم بتوريد المنتجات الناقصة
- خيار 2: اترك الفاتورة كما هي

---

### أمثلة عملية:

#### ✅ مثال 1: حذف فاتورة مبيعات (ناجح)
```
الفاتورة: مبيعات 50 قطعة - عميل أحمد
المرتجعات: لا يوجد
الإجراء: حذف
النتيجة: 
  ✅ تم الحذف
  ✅ أُضيفت 50 قطعة للمخزون
  ✅ عُكست القيود المحاسبية
```

#### ❌ مثال 2: حذف فاتورة مشتريات (فاشل)
```
الفاتورة: مشتريات 100 قطعة
المخزون الحالي: 30 قطعة (تم بيع 70)
الإجراء: حذف
النتيجة:
  ❌ رسالة خطأ: "الكمية المطلوبة: 100 • المتوفر: 30"
  ❌ لم يتم الحذف
```

#### ❌ مثال 3: حذف فاتورة لها مرتجع (فاشل)
```
الفاتورة: مبيعات 20 قطعة - عميل محمد
المرتجعات: مرتجع 1 (5 قطع)
الإجراء: حذف الفاتورة الأصلية
النتيجة:
  ❌ رسالة خطأ: "يوجد 1 مرتجع مرتبط"
  ❌ لم يتم الحذف
الحل الصحيح: احذف المرتجع أولاً، ثم الفاتورة
```

---

## ✏️ تعديل الفواتير

### القاعدة العامة:
> **فواتير المبيعات:** تعديل كامل ✅  
> **فواتير المشتريات:** الملاحظات فقط ❌

---

### خطوات تعديل فاتورة مبيعات:

1. **افتح صفحة الفواتير**
2. **ابحث عن فاتورة المبيعات**
3. **اضغط على "✏️ عرض/تعديل"**
4. **عدّل البيانات المطلوبة:**
   - الكميات
   - الأسعار
   - العميل
   - تاريخ الاستحقاق
   - الخ...
5. **اضغط "حفظ"**
6. **النظام سيقوم تلقائياً بـ:**
   - ✅ إرجاع الكميات القديمة للمخزون
   - ✅ عكس القيود المحاسبية القديمة
   - ✅ خصم الكميات الجديدة من المخزون
   - ✅ تسجيل القيود المحاسبية الجديدة

---

### رسائل الخطأ المحتملة:

#### ❌ "الكمية الإضافية المطلوبة غير متوفرة"
**السبب:** زدت الكمية المباعة والمخزون لا يكفي  

**مثال:**
```
الفاتورة القديمة: 10 قطع
الفاتورة الجديدة: 15 قطعة
الزيادة: 5 قطع
المخزون المتوفر: 3 قطع
❌ لا يمكن التعديل (تحتاج 5 وعندك 3 فقط)
```

**الحل:**
- خيار 1: قلل الكمية الجديدة
- خيار 2: وفّر المنتج في المخزون أولاً

---

### أمثلة عملية:

#### ✅ مثال 1: زيادة الكمية (ناجح)
```
الفاتورة القديمة: 10 قطع
الفاتورة الجديدة: 15 قطعة
المخزون: 20 قطعة

الإجراء: حفظ
النتيجة:
  ✅ تم التعديل
  ✅ أُرجعت 10 قطع للمخزون (أصبح 30)
  ✅ خُصمت 15 قطعة (أصبح 15)
  ✅ عُكست القيود القديمة
  ✅ سُجلت القيود الجديدة
```

#### ❌ مثال 2: زيادة الكمية (فاشل)
```
الفاتورة القديمة: 10 قطع
الفاتورة الجديدة: 18 قطعة
المخزون: 5 قطع
الزيادة المطلوبة: 8 قطع

الإجراء: حفظ
النتيجة:
  ❌ رسالة خطأ: "الزيادة المطلوبة: 8 • المتوفر: 5"
  ❌ لم يتم التعديل
```

#### ✅ مثال 3: تقليل الكمية (ناجح دائماً)
```
الفاتورة القديمة: 20 قطعة
الفاتورة الجديدة: 12 قطعة
المخزون: 0 قطع

الإجراء: حفظ
النتيجة:
  ✅ تم التعديل (لا يحتاج تحقق)
  ✅ أُرجعت 20 قطعة للمخزون (أصبح 20)
  ✅ خُصمت 12 قطعة (أصبح 8)
```

---

## 🔐 صلاحيات السندات

### ما الجديد؟
الآن يمكنك التحكم في صلاحيات السندات من واجهة إدارة المستخدمين!

### خطوات إضافة صلاحيات السندات:

1. **افتح الإعدادات**
2. **اختر "إدارة المستخدمين"**
3. **اختر المستخدم المطلوب**
4. **اضغط "تعديل الصلاحيات"**
5. **ستجد قسم جديد: "السندات (قبض وصرف)"**
6. **اختر الصلاحيات المطلوبة:**
   - ✅ عرض السندات
   - ✅ إنشاء سندات قبض
   - ✅ إنشاء سندات صرف
   - ✅ تعديل السندات
   - ✅ حذف السندات
7. **اضغط "حفظ الصلاحيات"**

---

## 🎓 نصائح وإرشادات

### ✅ أفضل الممارسات:

1. **قبل حذف فاتورة مشتريات:**
   - تأكد من توفر الكمية في المخزون
   - راجع تقارير المبيعات للفترة

2. **قبل حذف فاتورة مبيعات:**
   - تأكد من عدم وجود مرتجعات
   - راجع كشف حساب العميل

3. **عند تعديل فاتورة مبيعات:**
   - تأكد من توفر الكمية الإضافية (إذا زدت الكمية)
   - راجع المخزون أولاً

4. **استخدم التعديل بدلاً من الحذف:**
   - أسرع وأسهل
   - يحتفظ بالسجل المحاسبي
   - لا يحتاج إعادة إدخال جميع البيانات

---

### ❌ أخطاء شائعة:

#### خطأ 1: محاولة حذف فاتورة مشتريات قديمة
```
المشكلة: تم بيع معظم الكمية
الحل: اترك الفاتورة أو وفّر المنتج أولاً
```

#### خطأ 2: محاولة حذف الفاتورة قبل المرتجع
```
المشكلة: ترتيب خاطئ
الحل: احذف المرتجع أولاً، ثم الفاتورة
```

#### خطأ 3: زيادة الكمية بدون تحقق من المخزون
```
المشكلة: المخزون لا يكفي
الحل: راجع المخزون قبل التعديل
```

---

## 📊 جدول مرجعي سريع

| العملية | مشتريات | مبيعات | مرتجع |
|---------|---------|---------|--------|
| **الحذف** | ✅ مع تحقق | ✅ بدون تحقق | ❌ ممنوع |
| **التعديل** | ❌ ملاحظات فقط | ✅ كامل | ❌ ممنوع |
| **الإرجاع** | ✅ متاح | ✅ متاح | ❌ غير متاح |
| **زر الحذف** | ✅ يظهر | ✅ يظهر | ❌ مخفي |

---

## ❓ الأسئلة الشائعة

### س1: لماذا لا يظهر زر الحذف في المرتجع؟
**ج:** المرتجعات مرتبطة بفواتير أصلية ولا يمكن حذفها لحماية البيانات.

### س2: كيف أحذف فاتورة لها مرتجع؟
**ج:** احذف المرتجع أولاً، ثم احذف الفاتورة الأصلية.

### س3: لماذا لا يمكنني تعديل فاتورة مشتريات؟
**ج:** فواتير المشتريات تؤثر على تكلفة البضاعة، لذلك يُسمح بتعديل الملاحظات فقط.

### س4: ماذا أفعل إذا احتجت حذف فاتورة مشتريات والمخزون لا يكفي؟
**ج:** خياران:
1. وفّر المنتج في المخزون أولاً (بفاتورة مشتريات جديدة)
2. اترك الفاتورة القديمة كما هي

### س5: هل يمكنني استرجاع فاتورة محذوفة؟
**ج:** لا، الحذف نهائي. لذلك تظهر رسالة تأكيد مفصلة.

### س6: كيف أضيف صلاحيات السندات لمستخدم؟
**ج:** الإعدادات → إدارة المستخدمين → اختر المستخدم → تعديل الصلاحيات → قسم "السندات"

---

## 📞 المساعدة

في حالة وجود مشكلة:
1. اقرأ رسالة الخطأ بعناية
2. راجع الأمثلة في هذا الدليل
3. تأكد من الصلاحيات
4. تأكد من المخزون

---

**تم التحديث:** 2025-01-01  
**الإصدار:** 5.2


# ⚠️ لماذا لا يتم الخصم من الخزينة والبنوك؟

## 🔴 المشكلة التي تواجهها

عند إنشاء فاتورة أو إضافة منتج جديد للمخزون:
- ✅ الفاتورة تُنشأ بنجاح
- ✅ المنتج يُضاف للمخزون
- ❌ **لا يتم الخصم أو الإضافة في الخزينة والبنوك**

---

## ✅ الحل (السبب + الطريقة الصحيحة)

### 🎯 السبب الرئيسي:

**أنت لم تفعّل الخيارات المطلوبة!** 

في نهاية كل نموذج (فاتورة أو منتج)، يوجد **خياران** يجب تفعيلهما:

---

## 📄 1️⃣ عند إنشاء فاتورة مبيعات

### ❌ الطريقة الخاطئة (ما تفعله الآن):

عند ملء نموذج الفاتورة، تضغط "إنشاء الفاتورة" **مباشرة** ✖️

**النتيجة:**
- ✅ الفاتورة تُنشأ
- ❌ **لا يتم إضافة المبلغ للبنك/الخزينة**

---

### ✅ الطريقة الصحيحة:

**قبل** الضغط على "إنشاء الفاتورة"، انزل للأسفل وستجد:

```
┌───────────────────────────────────────────────────┐
│                                                   │
│  ☐ إنشاء قيد محاسبي تلقائي                       │
│                                                   │
│  ☐ تسجيل الدفع فوراً (إضافة للبنك/الخزينة)      │  ← يجب تفعيله!
│                                                   │
│  📋 اختر حساب البنك/الخزينة:                     │
│     [▼ -- اختر حساب البنك/الخزينة --]            │
│         • الخزينة النقدية (1001)                │
│         • البنك الوطني (1002)                    │
│         • بنك الخليج (1003)                      │
│                                                   │
└───────────────────────────────────────────────────┘

[حفظ التغييرات]  [إنشاء الفاتورة]
```

**الخطوات الصحيحة:**

1. املأ بيانات الفاتورة (العميل، المنتجات، إلخ)

2. **انزل للأسفل** ⬇️

3. ✅ **فعّل الخيار الأول:**
   ```
   ☑ إنشاء قيد محاسبي تلقائي
   ```

4. ✅ **فعّل الخيار الثاني:** (هذا المهم!)
   ```
   ☑ تسجيل الدفع فوراً (إضافة للبنك/الخزينة) 💰
   ```

5. 📋 **اختر الحساب:**
   - الخزينة النقدية (للدفع النقدي)
   - أو البنك الوطني (للتحويل البنكي)
   - أو بنك الخليج

6. **الآن اضغط "إنشاء الفاتورة"** ✅

---

### 📊 النتيجة بعد التفعيل:

**إذا بعت بـ 150 د.ك واخترت "الخزينة النقدية":**

✅ **في الفواتير:**
```
فاتورة رقم: INV-001
العميل: أحمد محمد
المبلغ: 150 د.ك
```

✅ **في القيود اليومية:**
```
قيد 1: فاتورة مبيعات رقم INV-001
- مدين: حساب أحمد محمد    150 د.ك
- دائن: المبيعات             150 د.ك

قيد 2: تحصيل فاتورة رقم INV-001
- مدين: الخزينة النقدية     150 د.ك  ← هنا المبلغ!
- دائن: حساب أحمد محمد      150 د.ك
```

✅ **في الخزينة والبنوك:**
```
الخزينة النقدية: +150 د.ك ⬆️ ✨
الرصيد الإجمالي: +150 د.ك ⬆️
```

---

## 📦 2️⃣ عند إضافة منتج للمخزون

### ❌ الطريقة الخاطئة (ما تفعله الآن):

عند ملء بيانات المنتج، تضغط "حفظ" **مباشرة** ✖️

**النتيجة:**
- ✅ المنتج يُضاف للمخزون
- ❌ **لا يتم خصم المبلغ من البنك/الخزينة**

---

### ✅ الطريقة الصحيحة:

**قبل** الضغط على "حفظ"، انزل للأسفل وستجد:

```
┌───────────────────────────────────────────────────┐
│                                                   │
│  ☐ تسجيل دفع الشراء (خصم من البنك/الخزينة) 💰   │  ← يجب تفعيله!
│                                                   │
│  سيتم خصم قيمة الشراء من الحساب المختار          │
│  وإنشاء قيد محاسبي تلقائياً                      │
│                                                   │
│  📋 اختر حساب الدفع: *                           │
│     [▼ -- اختر حساب الدفع --]                    │
│         • الخزينة النقدية (1001)                │
│         • البنك الوطني (1002)                    │
│         • بنك الخليج (1003)                      │
│                                                   │
│  ┌─────────────────────────────────────────────┐ │
│  │ إجمالي قيمة الشراء: 200.000 د.ك            │ │
│  │ (سعر الشراء 20 × الكمية 10)                │ │
│  └─────────────────────────────────────────────┘ │
│                                                   │
└───────────────────────────────────────────────────┘

[إلغاء]  [حفظ]
```

**الخطوات الصحيحة:**

1. املأ بيانات المنتج:
   - الاسم: دهان أبيض
   - SKU: DH-001
   - الكمية: 10
   - **سعر الشراء: 20 د.ك** (مهم!)
   - سعر البيع: 30 د.ك

2. **انزل للأسفل** ⬇️

3. ✅ **فعّل الخيار:**
   ```
   ☑ تسجيل دفع الشراء (خصم من البنك/الخزينة) 💰
   ```

4. 📋 **اختر الحساب:**
   - الخزينة النقدية (إذا دفعت نقداً)
   - أو البنك الوطني (إذا دفعت بشيك أو تحويل)

5. **سيظهر تلقائياً:**
   ```
   إجمالي قيمة الشراء: 200.000 د.ك
   ```

6. **الآن اضغط "حفظ"** ✅

---

### 📊 النتيجة بعد التفعيل:

**إذا اشتريت 10 علب × 20 د.ك = 200 د.ك:**

✅ **في المخزون:**
```
دهان أبيض
الكمية: 10 علبة
سعر الشراء: 20 د.ك
سعر البيع: 30 د.ك
```

✅ **في القيود اليومية:**
```
قيد: شراء دهان أبيض (10 piece)
- مدين: المخزون (1301)          200 د.ك
- دائن: الخزينة النقدية (1001)  200 د.ك  ← هنا الخصم!
```

✅ **في الخزينة والبنوك:**
```
الخزينة النقدية: -200 د.ك ⬇️ ✨
الرصيد الإجمالي: -200 د.ك ⬇️
```

---

## 🎬 دليل مصور خطوة بخطوة

### 📄 إنشاء فاتورة مبيعات بدفع فوري:

```
1. صفحة الفواتير → إضافة فاتورة جديدة
   ↓
2. اختر العميل: أحمد محمد
   ↓
3. أضف المنتجات:
   - دهان أبيض × 5 علب × 30 د.ك = 150 د.ك
   ↓
4. املأ باقي البيانات (تاريخ، وصف، إلخ)
   ↓
5. ⚠️ لا تضغط "إنشاء الفاتورة" بعد!
   ↓
6. انزل للأسفل ⬇️⬇️⬇️
   ↓
7. ✅ فعّل: إنشاء قيد محاسبي تلقائي
   ↓
8. ✅ فعّل: تسجيل الدفع فوراً 💰
   ↓
9. اختر: الخزينة النقدية (1001)
   ↓
10. الآن اضغط "إنشاء الفاتورة" ✅
    ↓
11. ✨ تحقق من النتيجة:
    - اذهب إلى 🏦 الخزينة والبنوك
    - رصيد الخزينة زاد بـ 150 د.ك ⬆️
```

---

### 📦 إضافة منتج للمخزون مع دفع:

```
1. صفحة المخزون → إضافة منتج جديد
   ↓
2. املأ البيانات:
   - الاسم: دهان أبيض
   - SKU: DH-001
   - الكمية: 10
   - سعر الشراء: 20 د.ك ← مهم!
   - سعر البيع: 30 د.ك
   ↓
3. ⚠️ لا تضغط "حفظ" بعد!
   ↓
4. انزل للأسفل ⬇️⬇️⬇️
   ↓
5. ✅ فعّل: تسجيل دفع الشراء 💰
   ↓
6. اختر: الخزينة النقدية (1001)
   ↓
7. سيظهر: إجمالي قيمة الشراء: 200.000 د.ك
   ↓
8. الآن اضغط "حفظ" ✅
   ↓
9. ✨ تحقق من النتيجة:
   - اذهب إلى 🏦 الخزينة والبنوك
   - رصيد الخزينة انخفض بـ 200 د.ك ⬇️
```

---

## 🔍 كيف تتحقق أن كل شيء يعمل؟

### الطريقة السهلة:

1. **افتح 🏦 الخزينة والبنوك**

2. **انظر إلى الأرقام الكبيرة في الأعلى:**
   ```
   ┌─────────────────────────────────────────┐
   │  💰 إجمالي الرصيد: XXX.XXX د.ك         │
   │  💵 الخزينة النقدية: XXX.XXX د.ك       │
   │  🏦 حسابات البنوك: XXX.XXX د.ك         │
   │  🔢 المتاح من المبيعات: XXX.XXX د.ك    │
   └─────────────────────────────────────────┘
   ```

3. **إذا كانت الأرقام تتغير** = ✅ النظام يعمل بشكل صحيح!

4. **إذا كانت الأرقام لا تتغير** = ❌ لم تفعّل الخيارات!

---

## 📌 ملخص سريع

| الموقف | يجب تفعيل | النتيجة |
|--------|-----------|---------|
| **بيع فاتورة نقداً** | ✅ إنشاء قيد محاسبي<br>✅ تسجيل الدفع فوراً | المبلغ يُضاف للبنك/الخزينة فوراً |
| **بيع فاتورة بالآجل** | ✅ إنشاء قيد محاسبي<br>❌ تسجيل الدفع فوراً | المبلغ يبقى في ذمة العميل |
| **شراء منتج نقداً** | ✅ تسجيل دفع الشراء | المبلغ يُخصم من البنك/الخزينة |
| **شراء منتج بالآجل** | ❌ تسجيل دفع الشراء | المبلغ يبقى في ذمتك للمورد |
| **جرد المخزون** | ❌ تسجيل دفع الشراء | فقط تسجيل الكمية الموجودة |

---

## ⚠️ خطأ شائع جداً

### ❌ المشكلة:
```
"أنا دائماً أملأ النموذج وأضغط حفظ مباشرة"
```

### ✅ الحل:
```
"انزل للأسفل ALWAYS قبل الضغط على حفظ/إنشاء"
"ابحث عن الخيارات الإضافية في نهاية النموذج"
"فعّل الخيار المطلوب حسب نوع العملية"
```

---

## 🎯 الخلاصة النهائية

**السبب الوحيد لعدم تحديث الخزينة والبنوك:**

> **أنت لا تفعّل الخيارات في نهاية النموذج!**

**الحل:**

1. ✅ **دائماً انزل للأسفل قبل الحفظ**
2. ✅ **ابحث عن الخيارات الإضافية**
3. ✅ **فعّل "تسجيل الدفع" إذا كنت تريد تحديث الرصيد**
4. ✅ **اختر الحساب المناسب**
5. ✅ **ثم احفظ**

---

## 📞 للمساعدة الفورية

إذا لم يعمل بعد هذه الخطوات:

1. **احذف جميع البيانات:**
   ```
   http://localhost:5174/clear-data.html
   ```

2. **ابدأ من جديد بالخطوات الصحيحة**

3. **راجع الأدلة:**
   - `PAYMENT_FEATURE_GUIDE.md` (للفواتير)
   - `INVENTORY_PAYMENT_GUIDE.md` (للمخزون)
   - `BANKING_USAGE_GUIDE.md` (للبنوك)

---

**تذكّر:** 💡

> النظام يعمل بشكل ممتاز!
> المشكلة فقط أنك لم تفعّل الخيارات المطلوبة.
> الخيارات موجودة في **نهاية** كل نموذج.
> انزل للأسفل دائماً! ⬇️⬇️⬇️

---

**تاريخ التحديث:** 25 أكتوبر 2025  
**الإصدار:** 2.1.1
